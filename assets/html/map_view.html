<!DOCTYPE html>
<html>
<head>
    <title>Map View</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script type="text/javascript" src="qrc:///qtwebchannel/qwebchannel.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }

        /* Floating action button */
        .fab {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 56px;
            height: 56px;
            background: var(--primary-color, #00f0ff);
            color: var(--bg-color, #0a0a0f);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 240, 255, 0.4);
            transition: all 0.2s;
        }
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 240, 255, 0.6);
        }
        .fab:active {
            transform: scale(0.95);
        }

        /* Search panel - hidden by default */
        .search-panel {
            position: absolute;
            top: 50px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 10, 15, 0.98);
            border: 1px solid var(--primary-color, #00f0ff);
            border-radius: 12px;
            padding: 16px;
            min-width: 320px;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .search-panel.active {
            display: block;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--primary-color, #00f0ff);
        }
        .panel-title {
            color: var(--text-color, #39ff14);
            font-size: 16px;
            font-weight: bold;
        }
        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-color, #39ff14);
            font-size: 24px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            line-height: 24px;
            padding: 0;
        }
        .close-btn:hover {
            color: var(--primary-color, #00f0ff);
        }

        .input-group {
            margin-bottom: 10px;
        }
        .input-label {
            color: var(--text-color, #39ff14);
            font-size: 11px;
            margin-bottom: 4px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .search-input {
            width: 100%;
            background: rgba(0, 20, 26, 0.8);
            border: 1px solid var(--primary-color, #00f0ff);
            color: var(--text-color, #39ff14);
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .search-input::placeholder {
            color: rgba(57, 255, 20, 0.4);
        }
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color, #00f0ff);
        }

        /* Style Google autocomplete dropdown */
        .pac-container {
            background-color: rgba(10, 10, 15, 0.98);
            border: 1px solid var(--primary-color, #00f0ff);
            border-radius: 8px;
            margin-top: 4px;
            font-family: Arial, sans-serif;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .pac-item {
            border-top: 1px solid rgba(0, 240, 255, 0.2);
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-color, #39ff14);
        }
        .pac-item:hover {
            background-color: rgba(0, 240, 255, 0.2);
        }
        .pac-item-query {
            color: var(--primary-color, #00f0ff);
            font-weight: bold;
        }
        .pac-icon {
            display: none;
        }
        .pac-matched {
            font-weight: bold;
            color: var(--primary-color, #00f0ff);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .btn {
            flex: 1;
            background: var(--primary-color, #00f0ff);
            color: var(--bg-color, #0a0a0f);
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.15s;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 240, 255, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn.secondary {
            background: rgba(0, 20, 26, 0.9);
            color: var(--text-color, #39ff14);
            border: 1px solid var(--primary-color, #00f0ff);
        }

        /* Navigation info panel */
        .nav-info-panel {
            position: absolute;
            top: 50px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 10, 15, 0.98);
            border: 2px solid var(--primary-color, #00f0ff);
            border-radius: 12px;
            padding: 16px;
            min-width: 300px;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .nav-info-panel.active {
            display: block;
        }
        .nav-stats {
            display: flex;
            gap: 20px;
            margin: 12px 0;
        }
        .stat {
            flex: 1;
        }
        .stat-value {
            color: var(--text-color, #39ff14);
            font-size: 20px;
            font-weight: bold;
        }
        .stat-label {
            color: var(--text-color, #39ff14);
            font-size: 11px;
            opacity: 0.6;
            text-transform: uppercase;
        }

        /* Compact controls */
        .compact-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .control-btn {
            width: 44px;
            height: 44px;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid var(--primary-color, #00f0ff);
            color: var(--text-color, #39ff14);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn:hover {
            background: rgba(0, 240, 255, 0.2);
            transform: scale(1.1);
        }
        .control-btn:active {
            transform: scale(0.95);
        }

        /* Status bar - minimalist */
        .status-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid var(--primary-color, #00f0ff);
            color: var(--text-color, #39ff14);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Status bar -->
    <div class="status-bar" id="status">Initializing...</div>

    <!-- Search panel (hidden by default) -->
    <div class="search-panel" id="searchPanel">
        <div class="panel-header">
            <span class="panel-title">üîç Navigate</span>
            <button class="close-btn" onclick="toggleSearch()">√ó</button>
        </div>
        <div class="input-group">
            <div class="input-label">From</div>
            <input type="text" class="search-input" id="originInput" placeholder="Current location">
        </div>
        <div class="input-group">
            <div class="input-label">To</div>
            <input type="text" class="search-input" id="destInput" placeholder="Destination">
        </div>
        <div class="btn-row">
            <button class="btn" onclick="searchAndNavigate()">üß≠ Go</button>
            <button class="btn secondary" onclick="searchLocation()">üîç Search</button>
        </div>
    </div>

    <!-- Navigation info panel -->
    <div class="nav-info-panel" id="navPanel">
        <div class="panel-header">
            <span class="panel-title">üß≠ Route</span>
            <button class="close-btn" onclick="closeNavigation()">√ó</button>
        </div>
        <div class="nav-stats">
            <div class="stat">
                <div class="stat-value" id="navDistance">--</div>
                <div class="stat-label">Distance</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="navDuration">--</div>
                <div class="stat-label">Duration</div>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn" onclick="startNavigation()">‚ñ∂ Start</button>
            <button class="btn secondary" onclick="clearRoute()">‚úï Clear</button>
        </div>
    </div>

    <!-- Compact controls (right side) -->
    <div class="compact-controls">
        <button class="control-btn" onclick="centerOnUser()" title="My Location">üìç</button>
        <button class="control-btn" id="styleBtn" onclick="toggleMapStyle()" title="Map Style">üé®</button>
    </div>

    <!-- Main FAB (search) -->
    <button class="fab" onclick="toggleSearch()">üîç</button>

    <script>
        let qmlBridge = null;
        let map = null;
        let directionsService = null;
        let directionsRenderer = null;
        let currentRoute = null;
        let currentStyle = 'dark';
        let mapInitialized = false;
        let mapInitializing = false;
        let loadHandlerCalled = false;
        let originAutocomplete = null;
        let destAutocomplete = null;
        let userLocation = null;
        let pendingTheme = null;
        let currentTheme = {
            bg: '#0a0a0f',
            primary: '#00f0ff',
            text: '#39ff14'
        };

        // Map styles
        const darkMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#0a0a0f" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#0a0a0f" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#39ff14" }] },
            {
                featureType: "administrative.locality",
                elementType: "labels.text.fill",
                stylers: [{ color: "#00f0ff" }]
            },
            {
                featureType: "poi",
                elementType: "labels.text.fill",
                stylers: [{ color: "#39ff14" }]
            },
            {
                featureType: "poi.park",
                elementType: "geometry",
                stylers: [{ color: "#0f2f1f" }]
            },
            {
                featureType: "road",
                elementType: "geometry",
                stylers: [{ color: "#1a1a2f" }]
            },
            {
                featureType: "road",
                elementType: "geometry.stroke",
                stylers: [{ color: "#00f0ff" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry",
                stylers: [{ color: "#2a2a4f" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry.stroke",
                stylers: [{ color: "#00f0ff" }]
            },
            {
                featureType: "water",
                elementType: "geometry",
                stylers: [{ color: "#001a2f" }]
            },
            {
                featureType: "water",
                elementType: "labels.text.fill",
                stylers: [{ color: "#00f0ff" }]
            }
        ];

        const retroMapStyle = [
            { elementType: "geometry", stylers: [{ color: "#100a00" }] },
            { elementType: "labels.text.stroke", stylers: [{ color: "#100a00" }] },
            { elementType: "labels.text.fill", stylers: [{ color: "#ffcf66" }] },
            {
                featureType: "administrative.locality",
                elementType: "labels.text.fill",
                stylers: [{ color: "#00ffcc" }]
            },
            {
                featureType: "road",
                elementType: "geometry",
                stylers: [{ color: "#2a1f00" }]
            },
            {
                featureType: "road",
                elementType: "geometry.stroke",
                stylers: [{ color: "#ffb400" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry",
                stylers: [{ color: "#3a2500" }]
            },
            {
                featureType: "road.highway",
                elementType: "geometry.stroke",
                stylers: [{ color: "#00ffcc" }]
            },
            {
                featureType: "water",
                elementType: "geometry",
                stylers: [{ color: "#0a0600" }]
            }
        ];

        new QWebChannel(qt.webChannelTransport, function(channel) {
            qmlBridge = channel.objects.qmlBridge;
            sendToQml('channelReady', {});
        });

        function sendToQml(cmd, payload) {
            if (qmlBridge) {
                qmlBridge.sendToQml(cmd, JSON.stringify(payload || {}));
            }
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        function toggleSearch() {
            const panel = document.getElementById('searchPanel');
            const navPanel = document.getElementById('navPanel');

            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
            } else {
                panel.classList.add('active');
                navPanel.classList.remove('active');
            }
        }

        function initMap(lat = 51.0447, lon = -114.0719, apiKey = 'YOUR_API_KEY_HERE') {
            if (mapInitialized) {
                console.log('Map already initialized');
                return;
            }

            if (mapInitializing) {
                console.log('Map initialization in progress');
                return;
            }

            if (!window.google) {
                mapInitializing = true;
                updateStatus('Loading map...');

                // Check if script already exists
                const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
                if (existingScript) {
                    console.log('Google Maps script already loading/loaded');
                    // Wait for it to finish
                    setTimeout(() => {
                        if (window.google && window.google.maps) {
                            createMap();
                        } else {
                            updateStatus('‚ö† Map failed to load');
                            mapInitializing = false;
                        }
                    }, 3000);
                    return;
                }

                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=createMap`;
                script.async = true;
                script.defer = true;
                script.onerror = function(e) {
                    console.error('Script load error:', e);
                    updateStatus('‚ö† Map load failed');
                    mapInitializing = false;
                };
                document.head.appendChild(script);
            } else {
                createMap();
            }
        }

        function createMap() {
            if (mapInitialized) {
                console.log('Map already created');
                return;
            }

            if (!window.google || !window.google.maps) {
                console.error('Google Maps not available');
                updateStatus('‚ö† Maps unavailable');
                mapInitializing = false;
                return;
            }

            try {
                // Determine initial map style based on theme
                const themeToUse = pendingTheme || currentTheme;
                let initialStyle = darkMapStyle;
                let styleName = 'dark';

                // Detect RetroVFD theme
                if (themeToUse.bg === '#100a00' || themeToUse.primary === '#00ffcc') {
                    initialStyle = retroMapStyle;
                    styleName = 'retro';
                    console.log('Starting with RetroVFD theme');
                } else {
                    console.log('Starting with Cyberpunk theme');
                }

                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 51.0447, lng: -114.0719 },
                    zoom: 13,
                    styles: initialStyle,
                    disableDefaultUI: true,
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.LEFT_BOTTOM
                    }
                });

                currentStyle = styleName;

                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer({
                    map: map,
                    suppressMarkers: false,
                    polylineOptions: {
                        strokeColor: themeToUse.primary,
                        strokeWeight: 4,
                        strokeOpacity: 0.8
                    }
                });

                // Initialize autocomplete for address inputs
                initAutocomplete();

                // Get user's current location on startup
                getCurrentLocation();

                mapInitialized = true;
                mapInitializing = false;
                updateStatus('üó∫Ô∏è Ready');
                sendToQml('mapReady', {});
            } catch (error) {
                console.error('Map creation error:', error);
                updateStatus('‚ö† Map error: ' + error.message);
                mapInitializing = false;
            }
        }

        // Make createMap global for Google Maps callback
        window.createMap = createMap;

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                console.log('Geolocation not available, using default test location');
                userLocation = { lat: 51.0447, lng: -114.0719 }; // Okotoks/Calgary area
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('Current location acquired:', userLocation);
                },
                function(error) {
                    console.log('Geolocation failed (' + error.message + '), using default test location');
                    userLocation = { lat: 51.0447, lng: -114.0719 }; // Fallback for desktop testing
                }
            );
        }

        function initAutocomplete() {
            if (!window.google || !window.google.maps || !window.google.maps.places) {
                console.warn('Google Places library not loaded');
                return;
            }

            try {
                // Get input elements
                const originInput = document.getElementById('originInput');
                const destInput = document.getElementById('destInput');

                // Create autocomplete for origin with updated API
                originAutocomplete = new google.maps.places.Autocomplete(originInput, {
                    fields: ['formatted_address', 'geometry', 'name'],
                    types: ['geocode', 'establishment']
                });

                // Create autocomplete for destination with updated API
                destAutocomplete = new google.maps.places.Autocomplete(destInput, {
                    fields: ['formatted_address', 'geometry', 'name'],
                    types: ['geocode', 'establishment']
                });

                // Bind autocomplete to map bounds for better suggestions
                if (map) {
                    originAutocomplete.bindTo('bounds', map);
                    destAutocomplete.bindTo('bounds', map);
                }

                // Handle place selection for origin
                originAutocomplete.addListener('place_changed', function() {
                    const place = originAutocomplete.getPlace();
                    if (!place.geometry) {
                        console.log('No details available for origin: ' + place.name);
                        return;
                    }
                    console.log('Origin selected:', place.formatted_address || place.name);
                });

                // Handle place selection for destination
                destAutocomplete.addListener('place_changed', function() {
                    const place = destAutocomplete.getPlace();
                    if (!place.geometry) {
                        console.log('No details available for destination: ' + place.name);
                        return;
                    }
                    console.log('Destination selected:', place.formatted_address || place.name);

                    // Optionally center map on selected destination
                    if (place.geometry.viewport) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        map.setCenter(place.geometry.location);
                        map.setZoom(15);
                    }
                });

                console.log('Autocomplete initialized successfully');
            } catch (error) {
                console.error('Error initializing autocomplete:', error);
            }
        }

        function toggleMapStyle() {
            if (!map) {
                updateStatus('‚ö† Map not ready');
                return;
            }

            if (currentStyle === 'dark') {
                map.setOptions({ styles: retroMapStyle });
                currentStyle = 'retro';
            } else if (currentStyle === 'retro') {
                map.setOptions({ styles: [] });
                currentStyle = 'default';
            } else {
                map.setOptions({ styles: darkMapStyle });
                currentStyle = 'dark';
            }
            updateStatus(`Style: ${currentStyle}`);
        }

        function centerOnUser() {
            if (!map) {
                updateStatus('‚ö† Map not ready');
                return;
            }

            updateStatus('Locating...');

            if (!navigator.geolocation) {
                updateStatus('‚ö† Geolocation unavailable');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Save user location for routing
                    userLocation = pos;

                    map.setCenter(pos);
                    map.setZoom(15);

                    new google.maps.Marker({
                        position: pos,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 8,
                            fillColor: currentTheme.text,
                            fillOpacity: 1,
                            strokeColor: currentTheme.primary,
                            strokeWeight: 2
                        },
                        title: 'Your Location'
                    });

                    updateStatus('‚úì Location found');
                    sendToQml('locationFound', { lat: pos.lat, lng: pos.lng });
                },
                function(error) {
                    let errorMsg = '‚ö† Location unavailable';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMsg = '‚ö† Location permission denied';
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        errorMsg = '‚ö† Position unavailable';
                    } else if (error.code === error.TIMEOUT) {
                        errorMsg = '‚ö† Location timeout';
                    }
                    updateStatus(errorMsg);
                    console.log('Geolocation error:', error);
                }
            );
        }

        function searchLocation() {
            if (!map) {
                updateStatus('‚ö† Map not ready');
                return;
            }

            const query = document.getElementById('destInput').value;
            if (!query) {
                updateStatus('‚ö† Enter location');
                return;
            }

            updateStatus('Searching...');

            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: query }, function(results, status) {
                if (status === 'OK' || status === google.maps.GeocoderStatus.OK) {
                    if (results && results[0]) {
                        const location = results[0].geometry.location;
                        map.setCenter(location);
                        map.setZoom(15);

                        new google.maps.Marker({
                            position: location,
                            map: map,
                            title: results[0].formatted_address
                        });

                        updateStatus('üìç Found');
                        toggleSearch();
                    } else {
                        updateStatus('‚ö† Not found');
                    }
                } else {
                    let errorMsg = '‚ö† Search failed';
                    if (status === 'REQUEST_DENIED') {
                        errorMsg = '‚ö† API key required';
                    }
                    updateStatus(errorMsg);
                    console.log('Geocode error:', status);
                }
            });
        }

        function searchAndNavigate() {
            if (!map || !directionsService) {
                updateStatus('‚ö† Map not ready');
                return;
            }

            let originValue = document.getElementById('originInput').value.trim();
            const dest = document.getElementById('destInput').value.trim();

            if (!dest) {
                updateStatus('‚ö† Enter destination');
                return;
            }

            updateStatus('Calculating...');

            // Check if origin is "Current location" or empty - use GPS
            const isCurrentLocation = !originValue ||
                                     originValue.toLowerCase() === 'current location' ||
                                     originValue === '';

            if (isCurrentLocation) {
                // If we don't have user location yet, try to get it
                if (!userLocation) {
                    updateStatus('Getting your location...');
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            console.log('Using current location:', userLocation);
                            calculateRoute(userLocation, dest);
                        },
                        function(error) {
                            updateStatus('‚ö† Could not get location');
                            console.error('Geolocation error:', error);
                        }
                    );
                    return;
                } else {
                    console.log('Using saved current location:', userLocation);
                    calculateRoute(userLocation, dest);
                    return;
                }
            }

            // Otherwise use the text address they entered
            calculateRoute(originValue, dest);
        }

        function calculateRoute(origin, destination) {
            const request = {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK' || status === google.maps.DirectionsStatus.OK) {
                    currentRoute = result;
                    directionsRenderer.setDirections(result);

                    const route = result.routes[0].legs[0];
                    document.getElementById('navDistance').textContent = route.distance.text;
                    document.getElementById('navDuration').textContent = route.duration.text;

                    document.getElementById('searchPanel').classList.remove('active');
                    document.getElementById('navPanel').classList.add('active');

                    updateStatus('‚úì Route ready');
                    sendToQml('routeCalculated', {
                        distance: route.distance.text,
                        duration: route.duration.text
                    });
                } else {
                    let errorMsg = '‚ö† Route failed';
                    if (status === 'NOT_FOUND') {
                        errorMsg = '‚ö† Location not found';
                    } else if (status === 'ZERO_RESULTS') {
                        errorMsg = '‚ö† No route found';
                    } else if (status === 'REQUEST_DENIED') {
                        errorMsg = '‚ö† API key required';
                    }
                    updateStatus(errorMsg);
                    console.log('Route error:', status);
                }
            });
        }

        function startNavigation() {
            updateStatus('‚ñ∂ Navigating');
            sendToQml('navigationStarted', {});
        }

        function closeNavigation() {
            document.getElementById('navPanel').classList.remove('active');
            updateStatus('üó∫Ô∏è Ready');
        }

        function clearRoute() {
            if (directionsRenderer) {
                directionsRenderer.setDirections({routes: []});
            }
            currentRoute = null;
            document.getElementById('originInput').value = '';
            document.getElementById('destInput').value = '';
            closeNavigation();
            updateStatus('‚úì Cleared');
        }

        function applyTheme(theme) {
            console.log('Applying theme:', JSON.stringify(theme));
            currentTheme = theme;
            pendingTheme = theme;

            document.documentElement.style.setProperty('--bg-color', theme.bg);
            document.documentElement.style.setProperty('--primary-color', theme.primary);
            document.documentElement.style.setProperty('--text-color', theme.text);

            // If map is already created, update it
            if (map) {
                // Detect which theme we're switching to
                if (theme.bg === '#100a00' || theme.primary === '#00ffcc') {
                    map.setOptions({ styles: retroMapStyle });
                    currentStyle = 'retro';
                    console.log('Switched to RetroVFD map style');
                } else {
                    map.setOptions({ styles: darkMapStyle });
                    currentStyle = 'dark';
                    console.log('Switched to Cyberpunk map style');
                }

                // Update route colors if route exists
                if (directionsRenderer && currentRoute) {
                    directionsRenderer.setOptions({
                        polylineOptions: {
                            strokeColor: theme.primary,
                            strokeWeight: 4,
                            strokeOpacity: 0.8
                        }
                    });
                    // Redraw the route to apply new colors
                    directionsRenderer.setDirections(currentRoute);
                }
            }
        }

        window.mapHandler = {
            handleCommand: function(cmd, payload) {
                console.log('Map command:', cmd);

                switch(cmd) {
                    case 'init':
                        if (!mapInitialized && !mapInitializing) {
                            initMap(payload.lat, payload.lng, payload.apiKey);
                        } else {
                            console.log('Map already initialized or initializing');
                        }
                        break;
                    case 'setLocation':
                        if (map) {
                            const pos = { lat: payload.lat, lng: payload.lng };
                            map.setCenter(pos);
                            map.setZoom(payload.zoom || 13);
                            if (payload.marker) {
                                new google.maps.Marker({
                                    position: pos,
                                    map: map,
                                    title: payload.label || 'Location'
                                });
                            }
                        } else {
                            console.warn('Map not ready');
                        }
                        break;
                    case 'navigate':
                        document.getElementById('originInput').value = payload.origin || '';
                        document.getElementById('destInput').value = payload.dest || '';
                        searchAndNavigate();
                        break;
                    case 'applyTheme':
                        applyTheme(payload);
                        break;
                }
            }
        };

        // Only initialize once on load
        window.addEventListener('load', function() {
            if (!loadHandlerCalled) {
                loadHandlerCalled = true;
                console.log('Map HTML ready, waiting for init command');
            }
        });

        // Fallback timeout - if map doesn't initialize in 10 seconds, show error
        setTimeout(function() {
            if (!mapInitialized && !mapInitializing) {
                console.log('Map initialization timeout - waiting for QML init command');
            } else if (mapInitializing && !mapInitialized) {
                console.error('Map stuck in initializing state');
                updateStatus('‚ö† Map timeout - try refreshing');
                mapInitializing = false;
            }
        }, 10000);
    </script>
</body>
</html>
